"App Engine Backend with Google Cloud Messaging" Template
===========================================

[Google Cloud Messaging](http://developer.android.com/google/gcm) (GCM) is a service that allows you to send push notifications from your server to your users' Android devices, and also to receive messages from devices on the same connection. The GCM service handles all aspects of queueing of messages and delivery to the target Android application running on the target device.

This backend template employs [Google Cloud Endpoints](https://developers.google.com/appengine/docs/java/endpoints) to to define a RESTful API which registers Android devices with your GCM server and allows you to send string messages to registered devices. After defining this API, strongly-typed client libraries are generated automatically and can be called from your Android app, as described below.

# 1. Adding a backend in Android Studio

To add the backend to your existing Android app from this backend template, open Android Studio ([installation instructions](https://developer.android.com/sdk/installing/studio.html)) and navigate to "Tools &rarr; Google Cloud Tools &rarr; Add App Engine Backend".

![Tools &rarr; Google Cloud Tools &rarr; Add App Engine Backend](/doc/img/add-app-engine-backend-menu-scaled.png)

In the dialog that appears, choose "App Engine Backends with Google Cloud Messaging" and enter module/package names for your new backend.

![Tools &rarr; Google Cloud Tools &rarr; Add App Engine Backend](/doc/img/add-app-engine-backend-menu-gcm.png)

Module name which you've entered above (marked with red 1) will be used in your Android Studio project. Package name (marked with red 2) will be used for all classes imported from this template and (reversed) for [Endpoints API namespaces](https://developers.google.com/appengine/docs/java/endpoints/annotations#apinamespace). In turn, Endpoints API namespaces will be used to derive the name of the autogenerated Android client libraries, hence this ensures that the names of generated client libraries match your package name.

![Added "HelloWorld" backend. Red numbers 1 and 2 indicate that the module name and the package names came from "New App Engine Module" dialog](/doc/img/added-backend-gcm.png)

## 1.1. Debugging the backend locally

As soon as the backend module is added to your project and Gradle sync finishes, a new run configuration with your backend's module name should be created:

![Created run configuration](/doc/img/run-configuration.png)

Launching this run configuration will invoke `appengineRun` task in [Gradle plug-in for App Engine](https://github.com/GoogleCloudPlatform/gradle-appengine-plugin), which in turn will start the local App Engine [Java development server](https://developers.google.com/appengine/docs/java/tools/devserver).

To ensure that your backend started successfully, navigate to [http://localhost:8080](http://localhost:8080). If everything went well, you should see the following page:

!["HelloWorld" backend running in local Java development server](/doc/img/devappserver-gcm.png)

# 2. Connecting your Android app to the backend

First of all, you need to add the [permissions required by Google Cloud Messaging](http://developer.android.com/google/gcm/client.html#manifest) into the Android manifest of your app (if they're not already there). To achieve this, add the following lines into your `AndroidManifest.xml` file:

```xml
<uses-permission android:name="android.permission.INTERNET" />
<uses-permission android:name="android.permission.GET_ACCOUNTS" />
<uses-permission android:name="android.permission.WAKE_LOCK" />
<uses-permission android:name="com.google.android.c2dm.permission.RECEIVE" />

<permission android:name="com.example.gcm.permission.C2D_MESSAGE" android:protectionLevel="signature" />
<uses-permission android:name="com.example.gcm.permission.C2D_MESSAGE" />
```

Secondly, install the client libraries generated for your newly-added Endpoints API into your [local Maven repository](https://maven.apache.org/guides/introduction/introduction-to-repositories.html) by selecting your backend module in Android Studio's "Project" pane and navigating to "Tools &rarr; Google Cloud Tools &rarr; Install Client Libraries".

!["Tools &rarr; Google Cloud Tools &rarr; Install Client Libraries" ](/doc/img/install-client-libraries.png)

Then add the dependencies on the installed client libraries to your Android app's `build.gradle` file:

```gradle
repositories {
    // Reference the local Maven repository
    mavenLocal()
}

dependencies {
    // Make sure that you have installed "Extras -> Google Play services" component in Android SDK Manager
    compile 'com.google.android.gms:play-services:3.1.+'

    compile ('com.google.http-client:google-http-client-android:1.18.0-rc') {
        exclude (group: 'com.google.android', module: 'android')
        exclude (group: 'org.apache.httpcomponents', module: 'httpclient')
    }

    compile ('<your package name>:messaging:v1-1.18.0-rc-SNAPSHOT') {
        exclude (group: 'org.apache.httpcomponents', module: 'httpclient')
    }
    compile ('<your package name>:registration:v1-1.18.0-rc-SNAPSHOT') {
        exclude (group: 'org.apache.httpcomponents', module: 'httpclient')
    }
}
```

Don't forget to replace `<your package name>` with your actual package name in `<your package name>:messaging:v1-1.18.0-rc-SNAPSHOT'` and `<your package name>:registration:v1-1.18.0-rc-SNAPSHOT'`!

(In this example, the resulting compile dependencies would be `com.google.sampleapp.backend:messaging:v1-1.18.0-rc-SNAPSHOT` and `com.google.sampleapp.backend:registration:v1-1.18.0-rc-SNAPSHOT`.)

If prompted by Android Studio, use "Sync Now" hyperlink in the top-right corner to inform the IDE about the changes to Gradle build files.

TBD: minimal set of client-side code which would attempt to register with the backend onCreate and would have a simple BroadcastReceiver to display a toast when the server sends a message.
